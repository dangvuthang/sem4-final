<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html xmlns:th="https://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{main_layout.html}">
    <head>
        <title>Admin/Tours - TRAVEL ToVN</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" sizes="76x76" th:href="@{/images/logo_32x32.png}">
    </head>
    <body>
        <div layout:fragment="sidebar-link">

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Tour Management
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item active" >
                <a class="nav-link " th:href="@{/admin/tours}" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                    <span>Tours</span>
                </a>
            </li>

            <!-- Nav Item - Utilities Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link " th:href="@{/admin/locations}" data-toggle="collapse" data-target="#collapseUtilities" aria-expanded="true" aria-controls="collapseUtilities">
                    <span>Locations</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link " th:href="@{/admin/tour_locations}" data-toggle="collapse" data-target="#collapseUtilities" aria-expanded="true" aria-controls="collapseUtilities">
                    <span>Tour Location</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link " th:href="@{/admin/tour_types}" data-toggle="collapse" data-target="#collapseUtilities" aria-expanded="true" aria-controls="collapseUtilities">
                    <span>Tour Types</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link " th:href="@{/admin/tour_images}" data-toggle="collapse" data-target="#collapseUtilities" aria-expanded="true" aria-controls="collapseUtilities">
                    <span>Tour Images</span>
                </a>
            </li>
            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                User Management
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link " th:href="@{/admin/roles}" data-toggle="collapse" data-target="#collapsePages" aria-expanded="true" aria-controls="collapsePages">
                    <span>Roles</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link " th:href="@{/admin/users}" data-toggle="collapse" data-target="#collapsePages" aria-expanded="true" aria-controls="collapsePages">
                    <span>Users</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link " th:href="@{/admin/bookings}" data-toggle="collapse" data-target="#collapsePages" aria-expanded="true" aria-controls="collapsePages">
                    <span>Bookings</span>
                </a>
            </li>
            <!-- Nav Item - Charts -->
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/guides}">
                    <span>Guides</span></a>
            </li>

            <!-- Nav Item - Tables -->
            <li class="nav-item">
                <a class="nav-link" th:href="@{/admin/statistics}">
                    <span>Statistics</span></a>
            </li>
        </div>
        <!--Modals -->
        <div layout:fragment="modal">
            <!-- The Modal Delete -->
            <div   class="modal" id="deleteModal"  tabindex="9999" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog"  role="document" >
                    <div class="modal-content" style="border-collapse: separate;border-radius: 15px" id="delete">
                        <form th:action="@{/admin/tours/active}" method="post">
                            <div class="modal-header">
                                <h3 style="color:#76C06C"></h3>
                            </div>
                            <div class="modal-body" >
                                <input type="text" id="idActive" name="tourId" th:value="${id}" hidden="true"/>
                                <p style="color:#76C06C">You are about to <span id="activeText" ></span> a tour, this procedure is irreversible.</p>
                                <p style="color:#76C06C">Do you want to proceed?</p>
                                <p></p>
                            </div>
                            <div class="modal-footer">
                                <input type="submit" style="width:50px;color:white;text-align:center;padding:5px;background-color:red;border: none" value="Yes"/>
                                <a href="#" data-dismiss="modal" style="width:50px;color:white;text-align:center;padding:5px;background-color:gray">No</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!--End Modal Delete-->
            <!-- The Modal Update -->
            <div   class="modal" id="updateModal"  tabindex="9999" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog"  role="document" >
                    <div class="modal-content" style="border-collapse: separate;border-radius: 15px" id="update">
                        <form id="updateForm" th:action="@{/admin/tours/update}" method="post" >
                            <div class="modal-header">
                                <h4 style="color:#76C06C;font-weight: bold;font-size: 20px " class="modal-title" id="myModalLabel">Update Tours</h4>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <input type="text" id="idUpdate" name="id" class="form-control" th:value="${id}" hidden="true">
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="name">Name:</label>
                                    <input type="text" id="nameUpdate" name="name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="startDate">Start Date:</label>
                                    <input type="date" id="startDateUpdate" name="start_Date" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="endDate">End Date:</label>
                                    <input type="date" id="endDateUpdate" name="end_Date" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="activeUpdate" name="active" class="form-control" value="true" hidden="true">
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="duration">Duration:</label>
                                    <input type="number" id="durationUpdate" name="duration" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="maxGroupSize">Max Group Size:</label>
                                    <input type="number" id="maxGroupSizeUpdate" name="maxGroupSize" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="price">Price:</label>
                                    <input type="number" id="priceUpdate" name="price" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="priceDiscount">Discount:</label>
                                    <input type="number" id="priceDiscountUpdate" name="priceDiscount" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="summary">Summary</label>
                                    <textarea id="summaryUpdate" name="summary" class="form-control" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="description">Description:</label>
                                    <textarea id="descriptionUpdate" name="description" class="form-control" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="tourTypeId">TourType</label>
                                    <select name="tourTypeId"  id="tourTypeIdUpdate" class="form-control" required>
                                        <option >Select Type</option>
                                        <option th:each="type : ${listTypes}" th:value="${type.id}" th:utext="${type.name}"></option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="guideID" >Guide</label>
                                    <select name="guideId"  id="guideIdUpdate" class="form-control" required>
                                        <option >Select Guide</option> 
                                        <option th:each="guide : ${listGuides}" th:value="${guide.id}" th:utext="${guide.getUserId().getName()}"></option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="tourImageCover">Tour Cover</label>
                                    <input id="pathUpdate" name="file"  type="file" hidden="true"/>
                                    <input type="text" id="imageUrlUpdate" name="tourImageCover"  class="form-control input"  required/>
                                    <img style="margin-top: 5% " width="150px" height="150px" src="" id="imageCoverUpdate"/>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel">
                                <input type="submit"  class="btn btn-success" value="Edit">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!--End Modal Update-->
            <!-- The Modal Add -->
            <div   class="modal" id="addModal"  tabindex="9999" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog"  role="document" >
                    <div class="modal-content" id="add">
                        <form id="addForm" th:action="@{/admin/tours}" method="post" >
                            <div class="modal-header">
                                <h4 style="color:#76C06C;font-weight: bold;font-size: 20px " class="modal-title" id="myModalLabel">Add Users</h4>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="name">Name:</label>
                                    <input  type="text" id="nameAdd" name="name" class="form-control" required />
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="startDate">Start Date:</label>
                                    <input type="date" id="startDateAdd" name="start_Date" class="form-control" required/>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="endDate">End Date:</label>
                                    <input type="date" id="endDateAdd" name="end_Date" class="form-control" required/>
                                </div>
                                <div class="form-group">
                                    <input type="text" id="activeAdd" name="active" class="form-control" value="true" hidden="true">
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="duration">Duration:</label>
                                    <input type="number" id="durationAdd" name="duration" class="form-control" required/>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="maxGroupSize">Max Group Size:</label>
                                    <input type="number" id="maxGroupSizeAdd" name="maxGroupSize" class="form-control" required/>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="price">Price:</label>
                                    <input type="number" id="priceAdd" name="price" class="form-control" required/>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="priceDiscount">Discount:</label>
                                    <input type="number" id="priceDiscountAdd" name="priceDiscount" class="form-control" required/>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="summary">Summary</label>
                                    <textarea id="summaryAdd" name="summary" class="form-control" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="description">Description:</label>
                                    <textarea id="descriptionAdd" name="description" class="form-control" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="tourTypeId">TourType</label>
                                    <select name="tourTypeId"  id="tourTypeIdAdd" class="form-control" required="true">
                                        <option value="">Select Type</option>
                                        <option th:each="type : ${listTypes}" th:value="${type.id}" th:utext="${type.name}"></option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="guideID" >Guide</label>
                                    <select name="guideId"  id="guideIdAdd" class="form-control" required="true">
                                        <option value="">Select Guide</option> 
                                        <option th:each="guide : ${listGuides}" th:value="${guide.id}" th:utext="${guide.getUserId().getName()}"></option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label style="color:#76C06C" th:for="tourImageCover">Tour Cover</label>
                                    <input id="pathAdd" name="file"  type="file" hidden="true"/>
                                    <input type="text" id="imageUrlAdd" name="tourImageCover"  class="form-control input"  required/>
                                    <img style="margin-top: 5% " width="150px" height="150px" src="" id="imageCoverAdd"/>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <input type="button" class="btn btn-default" data-dismiss="modal" value="Cancel">
                                <input type="submit"  id="addBtn" class="btn btn-success" value="Add">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!--End Modal Add-->

            <script type="text/javascript" th:inline='javascript'>
                $(document).ready(function (e) {

                    $('#priceDiscountAdd').change(function (e) {
                        var val = $(this).val();
                        if (val > 100 || val < 0) {
                            alert('Discount must be from 1 to 100!!!');
                        }
                    });
                    $('#priceDiscountUpdate').change(function (e) {
                        var val = $(this).val();
                        if (val > 100 || val < 0) {
                            alert('Discount must be from 1 to 100!!!');
                        }
                    });
                    $('#priceAdd').change(function (e) {
                        var val = $(this).val();
                        if (val > 10000 || val < 0) {
                            alert('Discount must be from 1 to 10000!!!');
                        }
                    });
                    $('#priceUpdate').change(function (e) {
                        var val = $(this).val();
                        if (val > 10000 || val < 0) {
                            alert('Discount must be from 1 to 10000!!!');
                        }
                    });
                    $('#startDateAdd').change(function (e) {
                        var endDate = $('#endDateAdd').val();
                        var startDate = $(this).val();
                        if (endDate !== '') {
                            if (new Date(endDate) <= new Date(startDate)) {
                                alert("Start date must be less than End date!!!");
                                $(':input[type="submit"]').attr('disabled', true);
                            }
                            if (new Date(endDate) > new Date(startDate)) {
                                $(':input[type="submit"]').prop('disabled', false);
                            }
                        }
                    })
                    $('#endDateAdd').change(function (e) {
                        var endDate = $(this).val();
                        var startDate = $('#startDateAdd').val();
                        if (startDate !== '') {
                            if (new Date(endDate) <= new Date(startDate)) {
                                alert("Start date must be less than End date!!!");
                                $(':input[type="submit"]').attr('disabled', true);
                            }
                            if (new Date(endDate) > new Date(startDate)) {
                                $(':input[type="submit"]').prop('disabled', false);
                            }
                        }
                    });
                    $('#startDateUpdate').change(function (e) {
                        var endDate = $('#endDateUpdate').val();
                        var startDate = $(this).val();
                        if (endDate !== '') {
                            if (new Date(endDate) <= new Date(startDate)) {
                                alert("Start date must be less than End date!!!");
                                $(':input[type="submit"]').attr('disabled', true);
                            }
                            if (new Date(endDate) > new Date(startDate)) {
                                $(':input[type="submit"]').prop('disabled', false);
                            }
                        }
                    })
                    $('#endDateUpdate').change(function (e) {
                        var endDate = $(this).val();
                        var startDate = $('#startDateUpdate').val();
                        if (startDate !== '') {
                            if (new Date(endDate) <= new Date(startDate)) {
                                alert("Start date must be less than End date!!!");
                                $(':input[type="submit"]').attr('disabled', true);
                            }
                            if (new Date(endDate) > new Date(startDate)) {
                                $(':input[type="submit"]').prop('disabled', false);
                            }
                        }
                    });
                    /*<![CDATA[*/
                    var msg = /*[[${msg}]]*/;
                    /*]]>*/
                    if (msg !== null) {
                        alert(msg);
                    }
                    $('#createButton').on("click", function (e) {
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        $('#addModal .modal-dialog').find('#add').css('display', 'block');
                        $('#updateModal .modal-dialog').find('#update').css('display', 'none');
                        $('#deleteModal .modal-dialog').find('#delete').css('display', 'none');
                        $('input[type=text]').val('');
                        $('input[type=number]').val('');
                        $('input[type=date]').val('');
                        $('textarea').val('');
                        $('select').val('');
                        $('#addModal').modal('show');
                        $('#addModal').on('shown.bs.modal', function (event) {
                            // reset the scroll to top
                            $('#addModal .modal-body').scrollTop(0);
                        });
                    });
                    $(".update").on("click", function (e) {
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        var origin = window.location.origin;
                        //Fill data
                        var spans = $(this).closest("tr").find("span");
                        var id = spans.eq(0).text();
                        $.ajax({
                            url: origin + "/admin/tours/" + id,
                            type: 'GET',
                            crossDomain: true,
                            dataType: 'json',
                            contentType: 'application/json',
                            success: function (data) {
                                //called when successful
                                var result = JSON.stringify(data);
                                var list = JSON.parse(result);
                                $('#idUpdate').val(list.id);
                                $('#nameUpdate').val(list.name);
                                $('#startDateUpdate').val(list.startDate);
                                $('#endDateUpdate').val(list.endDate);
                                $('#descriptionUpdate').val(list.description);
                                $('#summaryUpdate').val(list.summary);
                                $('#tourTypeIdUpdate option:contains(' + list.tourTypeId.name + ')').attr('selected', 'selected');
                                $('#guideIdUpdate option:contains(' + list.guideId.userId.name + ')').attr('selected', 'selected');
                                $('#imageUrlUpdate').val(list.tourImageCover);
                                $('#imageCoverUpdate').attr('src', "/images/" + list.tourImageCover);
                                $('#durationUpdate').val(list.duration);
                                $('#maxGroupSizeUpdate').val(list.maxGroupSize);
                                $('#priceDiscountUpdate').val(list.priceDiscount);
                                $('#priceUpdate').val(list.price);
                                $('#updateModal .modal-dialog').find('#update').css('display', 'block');
                                $('#addModal .modal-dialog').find('#add').css('display', 'none');
                                $('#deleteModal .modal-dialog').find('#delete').css('display', 'none');
                                $('#updateModal').modal('show');
                                $('#myModal').modal("show");
                                $('#updateModal').on('shown.bs.modal', function (event) {
                                    // reset the scroll to top
                                    $('#updateModal .modal-body').scrollTop(0);
                                });
                            },
                            error: function (e) {
                                //called when there is an error
                                console.log(e.message);
                            }
                        });
                    });
                    $(".delete").on('click', function (e) {
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        $('#delete .modal-dialog').find('#delete').css('display', 'block');
                        $('#addModal .modal-dialog').find('#add').css('display', 'none');
                        $('#updateModal .modal-dialog').find('#update').css('display', 'none');
                        var spans = $(this).closest("tr").find("span");
                        var checked = $(this).closest("div").find(".delete:visible").text();
                        $('#idActive').val(spans.eq(0).text());
                        if (checked === "Deactive") {
                            $('#delete').closest('div').find('h3').empty();
                            var title = $('#delete').closest('div').find('h3').html('Deactive Tour');
                            $('#activeText').html('deactive');
                            $('#deleteModal').modal('show');
                        } else {
                            $('#delete').closest('div').find('h3').empty();
                            var title = $('#delete').closest('div').find('h3').html('Active Tour');
                            $('#activeText').html('active');
                            $('#deleteModal').modal('show');
                        }
                    });
                    $('input[type=text]').closest('#imageUrlUpdate').click(function (e) {
                        $('#pathUpdate').trigger('click');
                    });
                    $('#pathUpdate').change(function (e) {
                        readUrlUpdate(this);
//                        $('#imageCoverAdd').attr('src', val);
                    });
                    $('input[type=text]').closest('#imageUrlAdd').click(function (e) {
                        $('#pathAdd').trigger('click');
                    });
                    $('#pathAdd').change(function (e) {
                        readUrlAdd(this);
//                        $('#imageCoverAdd').attr('src', val);
                    });
                    function readUrlUpdate(input) {
                        var file = input.files[0];
                        var fileType = file["type"];
                        var validImageTypes = ["image/gif", "image/jpeg", "image/png"];
                        if ($.inArray(fileType, validImageTypes) < 0) {
                            alert('Upload images only!!!');
                            return;
                        }
                        if (input.files && input.files[0]) {

                            var reader = new FileReader();
                            reader.onload = function (e) {
                                $('#imageCoverUpdate').attr('src', e.target.result);
                                var vals = $('#pathUpdate').val();
                                var val = vals.length ? vals.split('\\').pop() : '';
                                $('#imageUrlUpdate').val(val);
                            }

                            reader.readAsDataURL(input.files[0]);
                        }
                    }
                    function readUrlAdd(input) {
                        var file = input.files[0];
                        var fileType = file["type"];
                        var validImageTypes = ["image/gif", "image/jpeg", "image/png"];
                        if ($.inArray(fileType, validImageTypes) < 0) {
                            alert('Upload images only!!!');
                            return;
                        }
                        if (input.files && input.files[0]) {

                            var reader = new FileReader();
                            reader.onload = function (e) {
                                $('#imageCoverAdd').attr('src', e.target.result);
                                var vals = $('#pathAdd').val();
                                var val = vals.length ? vals.split('\\').pop() : '';
                                $('#imageUrlAdd').val(val);
                            }

                            reader.readAsDataURL(input.files[0]);
                        }
                    }
                });
            </script>
        </div>
        <!--Table-->
        <div layout:fragment="content">

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">LIST OF TOURS</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dataTable" cellspacing="0">
                            <thead>
                                <tr>
                                    <th rowspan="2" style="width: 10%;color:#76C06C ">ID</th>
                                    <th rowspan="2" style="color:#76C06C ">Name</th>
                                    <th colspan="2" style="color:#76C06C ">Date</th>
                                    <th rowspan="2" style="width: 10%;color:#76C06C">Active</th>
                                    <th rowspan="2" style="color:#76C06C ">Action</th>
                                </tr>
                                <tr>
                                    <th style="color:#76C06C ">Start Date</th>
                                    <th style="color:#76C06C ">End Date</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th style="color:#76C06C">ID</th>
                                    <th style="color:#76C06C ">Name</th>
                                    <th style="color:#76C06C ">Start Date</th>
                                    <th style="color:#76C06C ">End Date</th>
                                    <th style="color:#76C06C">Active</th>
                                    <th style="color:#76C06C ">Action</th>
                                </tr>
                            </tfoot>
                            <tbody>
                                <tr th:each="tour : ${list}">
                                    <td style="color:#76C06C"><span class="" th:text="${tour.id}"></span></td>
                                    <td style="color:#76C06C "><span class="" th:text="${tour.name}"></span></td>
                                    <td style="color:#76C06C "><span th:text="${tour.startDate}"></span></td>
                                    <td style="color:#76C06C "><span th:text="${tour.endDate}"></span></td>
                                    <td style="color:#76C06C "><input class="ch" type="checkbox" th:checked="${tour.getActive()}?'true':'false'"/></td>
                                    <td style="color:#76C06C  " class="button-update update">
                                        <div style="display: inline-block">
                                            <button
                                                id="updateBtn" class="update" style="border: 1px solid;border-radius: 8px;background: #007bff;color: white" th:data-id="${tour.id}" >Update</button>
                                            <button
                                                id="activeBtn" data-href=""
                                                class="button-delete delete" th:hidden="${tour.getActive()}?'false':'true'" style="text-align: center;width: 80px;border: 1px solid;border-radius: 8px;background: red;color: white" th:data-id="${tour.id}">Deactive</button>
                                            <button
                                                id="activeBtn" data-href=""
                                                class="button-delete delete" th:hidden="${tour.getActive()}?'true':'false'" style="text-align: center;width: 75px;border: 1px solid;border-radius: 8px;background: green;color: white" th:data-id="${tour.id}">Active</button>

                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
